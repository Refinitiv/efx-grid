<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: DataConnector.js</title>

    <script src="scripts/prettify.js"> </script>
    <script src="scripts/lang-css.js"> </script>
    <!--[if lt IE 9]&gt;
      &lt;script src="//html5shiv.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
    &lt;![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/default.css">
    <link type="text/css" rel="stylesheet" href="styles/elf-template.css">
</head>

<body>

<div id="main-template" class="elf-template">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Ext } from "../../node_modules/tr-grid-util/es6/Ext.js";
import { EventDispatcher } from "../../node_modules/tr-grid-util/es6/EventDispatcher.js";
import { Conflator } from "../../node_modules/tr-grid-util/es6/Conflator.js";
import ReferenceCounter from "./ReferenceCounter.js";
import ColumnDefinition from "./ColumnDefinition.js";
import RowDefinition from "./RowDefinition.js"; // eslint-disable-line

/**
* @constructor
* @extends {EventDispatcher}
*/
var DataConnector = function () {
	var t = this;
	t._commitRicsChanges = t._commitRicsChanges.bind(this);
	t._commitFieldsChanges = t._commitFieldsChanges.bind(this);
	t._fieldChangedConflator = new Conflator(0, t._commitFieldsChanges);
	t._ricChangedConflator = new Conflator(0, t._commitRicsChanges);
	t._fields = new ReferenceCounter();
	t._rics = new ReferenceCounter();
	t._rowDefMap = {};
};
Ext.inherits(DataConnector, EventDispatcher);


//#region Private Members
/** @type {Conflator}
* @private
*/
DataConnector.prototype._fieldChangedConflator = null;
/** @type {Conflator}
* @private
*/
DataConnector.prototype._ricChangedConflator = null;
/** @type {Object.&lt;string, RowDefinition&gt;}
* @private
*/
DataConnector.prototype._rowDefMap = null;
/** @type {ReferenceCounter}
* @private
*/
DataConnector.prototype._rics = null;
/** @type {ReferenceCounter}
* @private
*/
DataConnector.prototype._fields = null;
//#endregion Private Members

/** Get all ric with no duplication
 * @public
 * @returns {Array.&lt;string&gt;}
*/
DataConnector.prototype.getAllRics = function () {
	return this._rics.getAllReferences();
};

/** @public
 * @returns {Array.&lt;RowDefinition&gt;}
*/
DataConnector.prototype.getAllRowDefs = function () {
	var results = [];
	for (var i in this._rowDefMap) { // TODO: Check if push is better than concat
		results = results.concat(this._rowDefMap[i]);
	}
	return results;
};

/** Get all fields, including required fields and data fields, with no duplicate
* @public
* @return {!Array.&lt;string&gt;} New array is created
*/
DataConnector.prototype.getAllFields = function () {
	return this._fields.getAllReferences();
};

/** @public
 * @param {string} ric
 * @returns {Array.&lt;RowDefinition&gt;}
*/
DataConnector.prototype.getRowDefByRic = function (ric) {
	return this._rowDefMap[ric] || null;
};

/** @public
* @param {RowDefinition} rowDef
* @return {boolean} True if new reference is added.
*/
DataConnector.prototype.addRic = function (rowDef) {
	var ric = rowDef ? rowDef.getSymbol() : "";
	if(!ric) {
		return false;
	}

	var rowDefMap = this._rowDefMap;
	var rowDefs = rowDefMap[ric];
	if (!rowDefs) {
		rowDefs = rowDefMap[ric] = [rowDef];
	} else {
		if (rowDefs.indexOf(rowDef) &lt; 0) {
			rowDefs.push(rowDef);
		}
	}

	// Referer could be added, even if no new reference is added.
	var newReference = this._rics.addReference(ric, rowDef.getRowId());

	this._commitRicsChanges();
	return newReference;
};

/** @public
* @param {RowDefinition} rowDef Row defintion object used as a referer
* @param {string=} ric RIC to be removed
*/
DataConnector.prototype.removeRic = function (rowDef, ric) {
	if(!ric) {
		// TODO: RIC or permId maybe change during run-time, need to check before remove RIC/permId
		ric = rowDef ? rowDef.getSymbol() : "";
	}
	if(!ric) {
		return;
	}

	var rowDefMap = this._rowDefMap;
	var rowDefs = rowDefMap[ric];
	if (rowDefs) {
		var index = rowDefs.indexOf(rowDef);
		if (index &gt;= 0) {
			rowDefs.splice(index, 1);
		}
	}

	this._rics.removeReference(ric, rowDef.getRowId());
	this._commitRicsChanges();
};

/** @public
*/
DataConnector.prototype.removeAllRics = function () {
	var referers = this._rics.getAllReferers(); // TODO: Add method to removeAllReferers at once
	for (var i in referers) {
		this._rics.removeReferer(referers[i]);
	}
	this._rowDefMap = {};
	this._commitRicsChanges();
};

/** @private
*/
DataConnector.prototype._commitRicsChanges = function () {
	if (this._ricChangedConflator.conflate()) {
		return;
	}

	var rics = this._rics;
	var session = rics.getSession();
	var removedEntries = session.removedEntries;
	var newEntries = session.newEntries;

	if (removedEntries.length) {
		this._doDispatch({
			type: "ricRemoved",
			removedRics: removedEntries
		});
	}
	if (newEntries.length) {
		this._doDispatch({
			type: "ricAdded",
			addedRics: newEntries
		});
	}

	rics.newSession();
};

/** @public
* @param {string|Array.&lt;string&gt;|ColumnDefinition} fieldRef
* @param {string=} referer
*/
DataConnector.prototype.addFields = function (fieldRef, referer) {
	if (!fieldRef) { return; }

	var fields = this._fields;

	if (fieldRef instanceof ColumnDefinition) {
		fields.addReferences(fieldRef.getAllFields(), fieldRef.getId());
	} else {
		fields.addReferences(fieldRef, referer);
	}
	this._commitFieldsChanges();
};

/** @public
* @param {ColumnDefinition|string} fieldRef
* @param {string=} referer
*/
DataConnector.prototype.removeFields = function (fieldRef, referer) {
	if (!fieldRef) { return; }

	if (fieldRef instanceof ColumnDefinition) {
		this._fields.removeReferer(fieldRef.getId());
	} else {
		this._fields.removeReference(fieldRef, referer);
	}
	this._commitFieldsChanges();
};

/** @public
* @param {string} referrer
*/
DataConnector.prototype.removeFieldReferrer = function (referrer) {
	this._fields.removeReferer(referrer);
	this._commitFieldsChanges();
};

/** @public
*/
DataConnector.prototype.removeAllFields = function () {
	var referers = this._fields.getAllReferers();
	for (var i in referers) { // TODO: Add method to removeAllReferers at once
		this._fields.removeReferer(referers[i]);
	}
	this._commitFieldsChanges();
};

/** @private
*/
DataConnector.prototype._commitFieldsChanges = function () {
	if (this._fieldChangedConflator.conflate()) {
		return;
	}

	var fields = this._fields;
	var session = fields.getSession();
	var removedEntries = session.removedEntries;
	var newEntries = session.newEntries;

	if (removedEntries.length) {
		this._doDispatch({
			type: "fieldRemoved",
			removedFields: removedEntries
		});
	}
	if (newEntries.length) {
		this._doDispatch({
			type: "fieldAdded",
			addedFields: newEntries
		});
	}
	fields.newSession();
};

/** @private
* @param {Object} payload
*/
DataConnector.prototype._doDispatch = function (payload) {
	var t = this;
	payload.fields = t.getAllFields();
	payload.rics = t.getAllRics();
	payload.rowDefs = t.getAllRowDefs();
	t._dispatch(payload.type, payload);
};

/** @public
*/
DataConnector.prototype.reset = function () {
	var t = this;
	t._rowDefMap = {};
	t._fields.reset();
	t._rics.reset();
	t._fieldChangedConflator.reset();
	t._ricChangedConflator.reset();
};

export { DataConnector };
export default DataConnector;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ColumnDefinition.html">ColumnDefinition</a></li><li><a href="DataConnector.html">DataConnector</a></li><li><a href="Grid.html">Grid</a></li><li><a href="ReferenceCounter.html">ReferenceCounter</a></li><li><a href="RowDefinition.html">RowDefinition</a></li><li><a href="RowDefSorter.html">RowDefSorter</a></li><li><a href="SnapshotFiller.html">SnapshotFiller</a></li><li><a href="StyleLoader.html">StyleLoader</a></li></ul><h3>Events</h3><ul><li><a href="Grid.html#event:adcDataReceived">adcDataReceived</a></li><li><a href="Grid.html#event:beforeRowRemoved">beforeRowRemoved</a></li><li><a href="Grid.html#event:dataComposed">dataComposed</a></li><li><a href="Grid.html#event:fieldAdded">fieldAdded</a></li><li><a href="Grid.html#event:fieldRemoved">fieldRemoved</a></li><li><a href="Grid.html#event:pageCountChanged">pageCountChanged</a></li><li><a href="Grid.html#event:pageIndexChanged">pageIndexChanged</a></li><li><a href="Grid.html#event:ricAdded">ricAdded</a></li><li><a href="Grid.html#event:ricRemoved">ricRemoved</a></li></ul><h3>Global</h3><ul><li><a href="global.html#COL_DEF">COL_DEF</a></li><li><a href="global.html#ROW_DEF">ROW_DEF</a></li><li><a href="global.html#ROW_TYPES">ROW_TYPES</a></li></ul>
</nav>


<script src="scripts/linenumber.js"> </script>
<script src="scripts/prettify.js"> </script>
<script> prettyPrint(); </script>
</body>
</html>

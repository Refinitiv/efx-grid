<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: FieldDefinition.js</title>

    <script src="scripts/prettify.js"> </script>
    <script src="scripts/lang-css.js"> </script>
    <!--[if lt IE 9]&gt;
      &lt;script src="//html5shiv.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
    &lt;![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/default.css">
    <link type="text/css" rel="stylesheet" href="styles/elf-template.css">
</head>

<body>

<div id="main-template" class="elf-template">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// TODO: Merge this with Fields in mobile-mon repository
/* eslint-disable */
import Grid from "./Grid.js";
import RowDefinition from "./RowDefinition.js";
/* eslint-enable */
import { Deferred } from "../../node_modules/tr-grid-util/es6/Deferred.js";

/** @type {string}
* @private
* @const
*/
var SYNAPSE_URL =
	'/synapse/service/suggestions/suggest/?'
	+ 'hits=1' // search only 1 result
	+ '&amp;profile=' + encodeURIComponent('Field Selector');

/** @function
* @private
* @param {Object} e
*/
function xRicNameRenderer(e) {
	e.cell.setContent(e.rowDef.getDisplayText());
}
/** @function
* @private
* @param {RowDefinition} rowA
* @param {RowDefinition} rowB
* @param {number} order
* @returns {number}
*/
function xRicNameSorter(rowA, rowB, order) {
	var A = rowA.getDisplayText();
	var B = rowB.getDisplayText();
	if(A === B) {
		return 0;
	}
	if(!A) {
		return 1;
	}
	if(!B) {
		return -1;
	}
	if(A &lt; B) {
		return -order;
	}

	return order;
}


/* @namespace */
var FieldDefinition = {};

/** @type {Object.&lt;string, Object&gt;}
* @private
*/
FieldDefinition._defs = {
	"X_RIC_NAME": {
		name: "RIC",
		notRealTimeField: true,
		width: 100,
		binding: xRicNameRenderer,
		sortLogic: xRicNameSorter
	},
	"CF_NAME": {
		name: "Name",
		rank: 2800003,
		fieldDataType: "ALPHANUMERIC",
		id: "6307",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 100003,
		description: "The name of the instrument"
	},
	"CF_LAST": {
		name: "Last",
		rank: 2800024,
		fieldDataType: "PRICE",
		id: "5364",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 100024,
		description: "The latest trade price or value."
	},
	"PCTCHNG": {
		name: "Pct. Chng",
		rank: 2709440,
		fieldDataType: "PRICE",
		id: "56",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 9440,
		description: "Percentage change in the latest trade price or value from the historic close."
	},
	"CF_NETCHNG": {
		name: "Net. Chng",
		rank: 2800027,
		fieldDataType: "PRICE",
		id: "5367",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 100027,
		description: "Net Change is the difference between latest trade price or value and the historic closing value or settlement price."
	},
	"CF_CLOSE": {
		name: "Close",
		rank: 2800023,
		fieldDataType: "PRICE",
		id: "5360",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 100023,
		description: "The last trade price, settlement value or closing value."
	},
	"CF_CURR": {
		name: "Currency",
		rank: 2800021,
		fieldDataType: "ENUMERATED",
		id: "6452",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 100021,
		description: "The currency that the instrument is quoted in"
	},
	"CF_BID": {
		name: "Bid",
		rank: 2800025,
		fieldDataType: "PRICE",
		id: "5359",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 100025,
		description: "The latest Bid price."
	},
	"CF_ASK": {
		name: "Ask",
		rank: 2800026,
		fieldDataType: "PRICE",
		id: "5358",
		IsMonitorOnlyField: false,
		IsRealtimePortfolioField: false,
		IsRealtimeField: true,
		source: "IDN",
		sourceRank: 100026,
		description: "The latest Ask price."
	}
};
/** api-key to call synapse service
* @type {string}
* @private
* @const
*/
FieldDefinition._synapse = '';
/**
* @type {string}
* @private
* @const
*/
FieldDefinition._lang = 'en';

/**
 * @type {Object.&lt;string, boolean&gt;}
 * @private
 */
FieldDefinition._loadingField = {};

/** @public
* @function
* @param {string} field
* @param {Object} def
*/
FieldDefinition.set = function(field, def) {
	FieldDefinition._defs[field] = def || null;
};
/** @public
* @function
* @param {string} field
* @return {Object}
*/
FieldDefinition.get = function(field) {
	return FieldDefinition._defs[field];
};
/** @public
* @function
* @param {string} field
*/
FieldDefinition.remove = function(field) {
	delete FieldDefinition._defs[field];
};

/** @public
* @function
* @param {Grid~SynapseConfig} config
*/
FieldDefinition.setSynapseConfig = function (config) {
	FieldDefinition._synapse = config;

};

/** @public
* @function
* @param {string} field
* @param {Object} def
*/
FieldDefinition.set = function (field, def) {
	FieldDefinition._defs[field] = def || null;
};

/** to get more info about field via synapse service
* @private
* @param {string} field
* @returns {Promise}
*/
FieldDefinition.loadFieldInfo = function (field) {
	if (FieldDefinition._loadingField[field]) {
		return FieldDefinition._loadingField[field].promise;
	}

	var defer = new Deferred();
	var synapse = FieldDefinition._synapse;
	// cannot call request without synapse config
	if (!synapse) {
		defer.resolve(null);
	}
	// already have field definition then return
	else if (FieldDefinition._defs[field]) {
		defer.resolve(FieldDefinition._defs[field]);
	}
	// in debug using mock data instead
	else if (synapse.debug) {
		var mockData = this._mockOnLoadEndData(field, defer);
		setTimeout(onLoadEnd.bind(null, mockData), 1000);
	}
	// cannot call request without apiKey and  contextApp
	else if (!synapse.apiKey || !synapse.contextApp) {
		defer.resolve(null); // cannot request without apiKey and contextApp
	}
	// everything fine, call synapse service
	else {
		var queryUrl = SYNAPSE_URL
			+ '&amp;api-key=' + encodeURIComponent(synapse.apiKey)
			+ '&amp;contextApp=' + encodeURIComponent(synapse.contextApp)
			+ '&amp;language=' + encodeURIComponent(FieldDefinition._lang)
			+ '&amp;query=' + encodeURIComponent(field);
		if (synapse.auth) {
			queryUrl += '&amp;auth=' + encodeURIComponent(synapse.auth);
		}
		// TODO: handle client timeout
		var xmr = new XMLHttpRequest();
		xmr._defer = defer;
		xmr._field = field;
		FieldDefinition._loadingField[field] = defer;

		// for now we care only successful case
		xmr.addEventListener('loadend', onLoadEnd);
		xmr.addEventListener('timeout', onError);
		xmr.addEventListener('error', onError);
		xmr.open("GET", queryUrl, true); // true for asynchronous
		xmr.send();
	}
	return defer.promise;
};

/**
* @private
* @param {Event} e
*/
function onError(e) {
	// provide information for timeout and error cases and will be used in onLoadEnd handler
	e.currentTarget._error = {
		type: e.type
	};
}

/** @private
* @function
* @param {string} field
* @param {Object} defer
* @returns {Object}
*/
FieldDefinition._mockOnLoadEndData = function (field, defer) {
	var fieldUpperCase = field.toUpperCase();
	var fieldLowerCase = fieldUpperCase.toLowerCase();
	var label;
	if (fieldLowerCase.indexOf('_') === 2) { // transform XX_ABCD -&gt; Abcd
		label = fieldUpperCase[3] + fieldLowerCase.substring(4);
	} else {
		label = fieldUpperCase[0] + fieldLowerCase.substring(1);
	}
	var dataType = (fieldUpperCase.indexOf("DATE") &gt;= 0) ? "DATE" : "PRICE";
	var item = {
		cmd: label,
		explanation: null,
		fr: false,
		id: "1635614732",
		navigation: null,
		p: {
			Rank: 2800024,
			fdt: dataType,
			fid: "5364",
			fimo: false,
			firp: false,
			firt: true,
			fl: label,
			fn: fieldUpperCase,
			fsrc: "IDN",
			fsrnk: 100024
		},
		position: 0,
		preview: false,
		relations: {},
		score: 2840024,
		source: "87",
		subtitle: "",
		symbol: label,
		title: "title mockup of " + fieldUpperCase,
		vc: "FLD"
	};

	var response = {
		action: '\"' + fieldUpperCase + '\" SRCH',
		assetClassifierExplanation: "AssetClassifier is disabled.",
		assetClassifierStatus: "NOT_INVOKED",
		// header: { request: { … }, response: { … } }, // whatever
		result: [{ name: "Fields", default: false, size: 1, hits: [item], hasMore: false }],
		search: "cpurl://apps.cp./apps/SearchAll?Search.Value=" + fieldLowerCase + "*"
	};
	response = JSON.stringify(response);
	return {
		currentTarget: {
			_defer: defer,
			_field: field,
			status: 200,
			response: response,
			responseText: response
		}
	};
};

/**
* @private
* @param {Event} e
*/
function onLoadEnd(e) {
	var xmr = e.currentTarget;
	var defer = xmr._defer;
	var resolve = defer.resolve;
	var reject = defer.reject;

	delete FieldDefinition._loadingField[xmr._field];

	if (xmr.status === 200) { // case success
		var returnObj = {
			field: xmr._field,
			fieldDefinition: null
		};
		var res = JSON.parse(xmr.responseText);

		var result = res.result &amp;&amp; res.result[0];
		if (result) {
			var item = result.hits &amp;&amp; result.hits[0];
			if (item &amp;&amp; item.p) {
				var profile = item.p;
				if (profile.fn.toUpperCase() === xmr._field.toUpperCase()) {
					var fieldDef = FieldDefinition.get(xmr._field) || {};

					fieldDef.field = profile.fn; // name
					fieldDef.rank = profile.Rank;
					fieldDef.fieldDataType = profile.fdt; // data type
					fieldDef.IsMonitorOnlyField = profile.fimo;
					fieldDef.IsRealtimePortfolioField = profile.firp;
					fieldDef.IsRealtimeField = profile.firt;
					fieldDef.name = profile.fl; // label
					fieldDef.source = profile.fsrc;
					fieldDef.sourceRank = profile.fsrnk;
					fieldDef.description = item.title;

					FieldDefinition.set(xmr._field, fieldDef);
					returnObj.fieldDefinition = fieldDef;
				}
			}
		}
		resolve(returnObj);
	} else if (xmr._error) { // case error &amp;&amp; time out
		xmr._error.field = xmr._field;
		reject(xmr._error);
	} else { // case status not 200
		reject({
			field: xmr._field,
			status: xmr.status,
			statusText: xmr.statusText,
			request: xmr
		});
	}
}

(function() { // Add "field" property to all default field definitions. This reduces file size and redundancy
	for(var key in FieldDefinition._defs) {
		FieldDefinition._defs[key]["field"] = key;
	}
})();

export {FieldDefinition};
export default FieldDefinition;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ColumnDefinition.html">ColumnDefinition</a></li><li><a href="DataConnector.html">DataConnector</a></li><li><a href="Grid.html">Grid</a></li><li><a href="ReferenceCounter.html">ReferenceCounter</a></li><li><a href="RowDefinition.html">RowDefinition</a></li><li><a href="SnapshotFiller.html">SnapshotFiller</a></li><li><a href="StyleLoader.html">StyleLoader</a></li></ul><h3>Events</h3><ul><li><a href="Grid.html#event:adcDataReceived">adcDataReceived</a></li><li><a href="Grid.html#event:beforeRowRemoved">beforeRowRemoved</a></li><li><a href="Grid.html#event:dataComposed">dataComposed</a></li><li><a href="Grid.html#event:fieldAdded">fieldAdded</a></li><li><a href="Grid.html#event:fieldRemoved">fieldRemoved</a></li><li><a href="Grid.html#event:pageCountChanged">pageCountChanged</a></li><li><a href="Grid.html#event:pageIndexChanged">pageIndexChanged</a></li><li><a href="Grid.html#event:ricAdded">ricAdded</a></li><li><a href="Grid.html#event:ricRemoved">ricRemoved</a></li></ul><h3>Global</h3><ul><li><a href="global.html#COL_DEF">COL_DEF</a></li><li><a href="global.html#ROW_DEF">ROW_DEF</a></li></ul>
</nav>


<script src="scripts/linenumber.js"> </script>
<script src="scripts/prettify.js"> </script>
<script> prettyPrint(); </script>
</body>
</html>
